#textdomain wesnoth-voadar
[scenario]
    
    id=3_Valor
    name= _ "Valor"
    next_scenario=null
    map_data="{~add-ons/Voyage_of_a_Drake/maps/valor.map}"
    turns=-1
    victory_when_enemies_defeated=no
    
    # Temporary music
	# (will be changed during the intro cut-scene)
    {INTRO_AND_SCENARIO_MUSIC revelation.ogg vengeful.ogg}

    # The story
    [story]
        [part]
            story= _ "Nhardril and Maple quickly passed around word of another town meeting. Everyone's reactions were the same: nervous listening and uneasy agreement to attend. The next evening, the atmosphere was tense like a drawn bowstring as the villagers gathered."
            background="story/landscape-hills-01.jpg"
        [/part]
        [part]
            story= _ "Anxious small talk buzzed through the crowded tavern until Nhardril called for everyone's attention. A stifling quiet filled the room, penetrated only by Maple as she related what had happened to her and Voadar. By the time her brief recollection ended, the tense air was beginning to crack. Angry whispers were followed by angry yells, and it seemed the village was finally willing to take action."
            background="story/landscape-hills-01.jpg"
        [/part]
    [/story]

    # Set the objectives
    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Avenge Cadameron"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Voadar"
                condition=lose
            [/objective]
        [/objectives]
    [/event]
    
    # TODO finalize dawn vs dusk and fix the turn sound effect
    #{DAWN_HOUR}
    {DUSK_HOUR}
	[event]
		name=prestart
		[time_area]
			x=34-51
			{INDOORS}
		[/time_area]
	[/event]

    # The player's side
    [side]
        {VOADAR_SIDE_BASICS}
        side=1
        controller=human
        gold=0
        fog=yes
        shroud=yes
        team_name=raplice
        color=orange
        {FLAG_VARIANT loyalist}
    [/side]
	
    # Enemy's side
    [side]
        {VOADAR_SIDE_BASICS}
        side=2
        team_name=foes
        color=teal
        shroud=no
        gold=500
        [ai]
            aggression=1
            caution=.35
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=.9
            [/goal]
        [/ai]
        {FLAG_VARIANT loyalist}
    [/side]

    # Make sure units are healable & full hp
	# TODO this is bugged for [unstore_unit]?
	[event]
		name=unit placed
		id=units_are_healable
		first_time_only=no
        [modify_unit]
            [filter]
                x,y=$x1|,$y1
            [/filter]
            [status]
                unhealable=no
				poisoned=no
				slowed=no
            [/status]
			hitpoints=$unit.max_hitpoints|
            # also, there is no such thing as upkeep:
            upkeep=loyal
        [/modify_unit]
	[/event]
    
    # Beginning shroud placement
	[event]
		name=prestart
		[place_shroud]
			side=1
			x=0-33
		[/place_shroud]
	[/event]
	
	
	# This one is just a ton of different prestart things that must happen in sequence
	[event]
		name=prestart
		################################################
		# a debug tool: change the persistent variables just before the scenario starts
		# to use, use this debug command before ending 2_Voyage:
		# :set_var persist.change_vars=yes
		################################################
		[if]
			[variable]
				name=persist.change_vars
				equals=yes
			[/variable]
			[then]
				{VARIABLE break no}
				[while]
					[variable]
						name=break
						equals=no
					[/variable]
					[do]
						[message]
							speaker=narrator
							image=wesnoth-icon.png
							caption=_"Setup persist vars"
							[option]
								label=_"Ready - begin level"
								[command]
									{VARIABLE break yes}
								[/command]
							[/option]
							[option]
								label=_"Inspect"
								[command]
									[inspect]
									[/inspect]
								[/command]
							[/option]
							[option]
								label=_"Change var"
								[command]
									[message]
										speaker=narrator
										image=wesnoth-icon.png
										caption=_"Variable name"
										[text_input]
											variable=var_name
											text="persist."
										[/text_input]
									[/message]
									[message]
										speaker=narrator
										image=wesnoth-icon.png
										caption=_"New value"
										[text_input]
											variable=new_val
											text="yes"
										[/text_input]
									[/message]
									{VARIABLE $var_name| $new_val|}
								[/command]
							[/option]
						[/message]
					[/do]
				[/while]
				{CLEAR_VARIABLE break,var_name,new_val}
			[/then]
		[/if]
	
		# unpack a couple of the persist variables:
		{CLEAR_VARIABLE Voadar}
		{VARIABLE Voadar.has_potion $persist.Voadar.has_potion|}
		{VARIABLE Voadar.ranged_attack_unlocked $persist.Voadar.ranged_attack_unlocked|}

		################################################
		# Place all the characters
		# Just make each unit, and put it in a generic position
		#
		# choosing which ones appear/stick around to help comes next
		################################################
		
		{VARIABLE persist.Voadar.unit.facing sw}
		[unstore_unit]
			variable=persist.Voadar.unit
			x,y=45,3
			fire_event=yes
		[/unstore_unit]
		
#define VOADAR_SCENARIO_UNIT TYPE ID NAME X Y FACING TRAIT_ONE TRAIT_TWO WML
    [unit]
        id={ID}
        name={NAME}
        x,y={X},{Y}
        type={TYPE}
        side=2
        facing={FACING}
        [modifications]
            {TRAIT_{TRAIT_ONE}}
            {TRAIT_{TRAIT_TWO}}
        [/modifications]
        {WML}
    [/unit]
#enddef
		# What is the NE in front of each unit type?
		# "No Event"
		# The main unit types have the NE versions as [base_unit]s, but add
		# all kinds of horrid events for controlling the schedules
        {VOADAR_SCENARIO_UNIT "NE Business Dwarf" "Nhardril" (_"Nhardril") 46 3 sw INTELLIGENT HEALTHY ()}
        {VOADAR_SCENARIO_UNIT "NE Voadar Elvish Druid" "Maple" (_"Maple") 47 4 sw QUICK DEXTROUS ()}
        {VOADAR_SCENARIO_UNIT "NE Voadar Dwarvish Runesmith" "Anatus" (_"Anatus") 41 7 se STRONG HEALTHY ()}
        {VOADAR_SCENARIO_UNIT "NE Voadar Dwarvish Steelclad" "Anatil" (_"Anatil") 42 6 se RESILIENT INTELLIGENT ()}
        {VOADAR_SCENARIO_UNIT "NE Village Elder" "Ivan" (_"Ivan") 40 7 se AGED RESILIENT ()}
        {VOADAR_SCENARIO_UNIT "NE Village Preacher" "Father_aristo" (_"Father Aristo") 39 4 se INTELLIGENT WEAK ()}
        {VOADAR_SCENARIO_UNIT "NE Dog" "Fifo" (_"Fifo") 41 3 se STRONG INTELLIGENT ()}
        {VOADAR_SCENARIO_UNIT "NE Aristocrat" "Mrs_aristo" (_"Mrs. Aristo") 40 3 se INTELLIGENT WEAK (gender=female)}
        {VOADAR_SCENARIO_UNIT "NE Young Aristocrat" "Robert" (_"Robert") 38 4 se INTELLIGENT STRONG ()}
        {VOADAR_SCENARIO_UNIT "NE Village Tramp" "Klippy" (_"Klippy") 42 7 se QUICK INTELLIGENT (gender=female)}
        {VOADAR_SCENARIO_UNIT "NE Carpenter" "Frank" (_"Frank") 39 6 se INTELLIGENT STRONG ()}
        {VOADAR_SCENARIO_UNIT "NE Village Introvert" "Juditha" (_"Juditha") 40 6 se RESILIENT STRONG (gender=female)}
        {VOADAR_SCENARIO_UNIT "NE Young Fisher" "Rachael" (_"Rachael") 40 5 se INTELLIGENT QUICK (gender=female)}
        {VOADAR_SCENARIO_UNIT "NE Postmaster" "Curryan" (_"Curryan") 42 4 se QUICK LOYAL (gender=female)}
        {VOADAR_SCENARIO_UNIT "NE Groom" "Hob" (_"Hob") 41 5 se DIM WEAK ()}
        {VOADAR_SCENARIO_UNIT "NE Cobbler" "Leonna" (_"Leonna") 40 4 se QUICK DEXTROUS ()}
        {VOADAR_SCENARIO_UNIT "NE Seasoned Farmer" "Vyncent" (_"Vyncent") 42 3 se STRONG QUICK ()}
        {VOADAR_SCENARIO_UNIT "NE Voadar Elvish Champion" "Commodir" (_"Commodir") 44 5 se STRONG QUICK ()}
        {VOADAR_SCENARIO_UNIT "NE Voadar Elvish Sharpshooter" "Tetaitiel" (_"Tetaitiel") 44 6 se DEXTROUS INTELLIGENT (gender=female)}
        {VOADAR_SCENARIO_UNIT "NE Voadar Orcish Crossbowman" "Grigar" (_"Grigar") 37 6 se RESILIENT QUICK ()}
		
        {VOADAR_SCENARIO_UNIT "NE Voadar Pikeman" "Harold" (_"Harold") 43 2 se RESILIENT QUICK ()}
        {VOADAR_SCENARIO_UNIT "NE Voadar General" "George" (_"George") 43 3 se STRONG LOYAL ()}
        {VOADAR_SCENARIO_UNIT "NE Voadar Longbowman" "Gwain" (_"Gwain") 42 2 se STRONG DEXTROUS()}
		
        {VOADAR_SCENARIO_UNIT "NE Elvish Tourist" "Nickieldur" (_"Nickieldur") 45 5 se DEXTROUS QUICK ()}
        {VOADAR_SCENARIO_UNIT "NE Human Tourist" "Derek" (_"Derek") 46 5 se STRONG RESILIENT ()}
        {VOADAR_SCENARIO_UNIT "NE Dunefolk Tourist" "Rayyan" (_"Rayyan") 44 4 se QUICK STRONG ()}
		
		# Maple was made pretty weak for the Dogifforo fight, she needs a powerup for this one:
		[modify_unit]
			[filter]
				id=Maple
			[/filter]
			[effect]
				apply_to=attack
				name=staff
				set_damage=8
			[/effect]
			[effect]
				apply_to=attack
				name=entangle
				set_damage=6
				set_number=3
			[/effect]
			[effect]
				apply_to=new_attack
				name=thorns
				description=_"thorns"
				type=pierce
				[specials]
					{WEAPON_SPECIAL_MAGICAL}
				[/specials]
				damage=8
				number=3
				range=ranged
			[/effect]
		[/modify_unit]
		
		# also, she and Father Aristo can be healers now
		[modify_unit]
			[filter]
				id=Maple
			[/filter]
			[effect]
				apply_to=new_ability
				[abilities]
					{ABILITY_CURES}
				[/abilities]
			[/effect]
		[/modify_unit]
		[modify_unit]
			[filter]
				id=Father_aristo
			[/filter]
			[effect]
				apply_to=new_ability
				[abilities]
					{ABILITY_CURES}
				[/abilities]
			[/effect]
		[/modify_unit]
		
		# and Robert might have a sword:
		{IF_VAR persist.Robert.quest_complete equals yes (
			[then]
				{VOADAR_STORE_UNIT Robert no}
				{VARIABLE Robert.unit.attack[0].name "short sword"}
				{VARIABLE Robert.unit.attack[0].description (_"short sword")}
				{VARIABLE Robert.unit.attack[0].icon attacks/sword-human-short.png}
				{VARIABLE Robert.unit.attack[0].type blade}
				{VARIABLE Robert.unit.attack[0].damage 10}
				{VARIABLE Robert.unit.attack[0].number 3}
				[unstore_unit]
					variable=Robert.unit
					find_vacant=no
				[/unstore_unit]
			[/then]
		)}
		
		################################################
		# Next, decide which units are present when the scenario first starts
		# Some will reappear later, but that is dealt with at the same time as dialog
		################################################
		
		# the guards will appear shortly
		{VOADAR_STORE_UNIT Harold yes}
		{VOADAR_STORE_UNIT Gwain yes}
		{VOADAR_STORE_UNIT George yes}
		
		# tourists only appear initially if they aren't going to help
		{IF_VAR persist.Nickieldur.quest_complete equals yes (
			[then]
				{VOADAR_STORE_UNIT Rayyan yes}
				{VOADAR_STORE_UNIT Nickieldur yes}
				{VOADAR_STORE_UNIT Derek yes}
				# additionally, if Robert has befriended them, he'll show up when they do
				{IF_VAR persist.Robert.quest_complete equals yes (
					[then]
						{VOADAR_STORE_UNIT Robert yes}
						# and let's not waste that spot
						{TELEPORT_UNIT (id=Fifo) 38 4}
					[/then]
				)}
			[/then]
		)}
		
		# These three only show up at all if they do help
		{IF_VAR persist.Leonna.quest_complete equals no (
			[then]
				[kill]
					id=Leonna
				[/kill]
			[/then]
		)}
		{IF_VAR persist.Grigar.quest_complete equals no (
			[then]
				[kill]
					id=Grigar
				[/kill]
			[/then]
		)}
		{IF_VAR persist.farmers.quest_complete equals no (
			[then]
				[kill]
					id=Vyncent
				[/kill]
			[/then]
		)}
		
	[/event]
	
	################################################
	# Next: The stuff that hasn't been done yet
	# yep that was pretty vague
	# Think of this long section as the opening cutscene.
	# Characters come and go, and there are a ton of messages
	################################################
	[event]
		name=start
		
		#
		# An overview of how the conversation should be shaped
		# High energy, accusations (easy part, since this script is more or 
		#	less independent of whose support you have)
		# Sudden crash, apathy/fear begin to set back in
		# 	(explain people who aren't helping, or people who only need to say
		# 	 say something if they're leaving)
		# Rise as supporters state their stance, ending with people who only
		# 	say things when they help
		# Then the military arrives.
		#
		
		[unstore_unit]
			variable=Harold.unit
			x,y=36,4
		[/unstore_unit]
		{MOVE_UNIT (id=Harold) 43 2}
		{VOADAR_MESSAGE Harold (_"<i>(Scowls)</i> Just like I thought...")}
		[unstore_unit]
			variable=George.unit
			x,y=36,4
		[/unstore_unit]
		{MOVE_UNIT (id=George) 43 3}
		[unstore_unit]
			variable=Gwain.unit
			x,y=36,4
		[/unstore_unit]
		{MOVE_UNIT (id=Gwain) 42 2}
		
		{VOADAR_MESSAGE George (_"<i>Oh no...</i> Gentlemen, please! Not this again!")}
		{VOADAR_MESSAGE Nhardril (_"Sorry, George. It's about more than taxes, now.")}
		{VOADAR_MESSAGE Mrs_aristo (_"Maple says that Dogifforo has admitted to murdering Cadameron! On orders from Mayor Ronry, no less!")}
		{VOADAR_MESSAGE Anatil (_"Aye, and we all know she's not one to tell a lie!")}
		{VOADAR_MESSAGE Frank (_"That's right! The mayor's been acting shady long enough that there isn't much reason to doubt, is there?")}
		{VOADAR_MESSAGE Juditha (_"<i>(Sneers)</i> Just how much did you already know about this, 'General?'")}
		{VOADAR_MESSAGE George (_"I, nothing, of course! All of you know better than to think I'd stand for something like that, but nevertheless--")}
		{VOADAR_MESSAGE Anatus (_"Nevertheless! Nevertheless nothing! Of course you didn't know more about this than any o' the rest o' us, but ye' best not be trying to defend Ronry, neither!")}
		{VOADAR_MESSAGE Gwain (_"I... George, I think they're right. And we couldn't let those taxes go on forever, anyway.")}
		# Vyncent might not be here, but in that case this message will safely be skipped:
		{VOADAR_MESSAGE Vynent (_"I say we march straight to the town hall and kick him out! By force, if that's what it takes!")}
		
		# Klippy slips out:
		{MOVE_UNIT (id=Klippy) 43 8}
		[kill]
			id=Klippy
		[/kill]
		
		{VOADAR_MESSAGE Commodir (_"No one can deny the need for action, whatever that might entail.")}
		{VOADAR_MESSAGE Nhardril(_"We all know what has to be done! Aye???")}
		
		{REPLACE_SCENARIO_MUSIC silence.ogg}
		[delay]
			time=3000
		[/delay]
		{VOADAR_MESSAGE Ivan (_"Well, maybe we're just being a wee bit hasty here, eh?")}
		[delay]
			time=3000
		[/delay]
		{REPLACE_SCENARIO_MUSIC suspense.ogg}
		
		# First split: explain farmers:
		{VOADAR_MESSAGE Mrs_aristo (_"Where is Pema? She's a respectable lady, I want her thoughts.")}
		[if]
			[have_unit]
				id=Vyncent
			[/have_unit]
			[then]
				{VOADAR_MESSAGE Vyncent (_"She... she's with the kids, somewhere safe. But... but she agrees with me! We can't let Ronry keep getting his way!")}
			[/then]
			[else]
				{VOADAR_MESSAGE Maple (_"She... she said she needed to prioritize the children. Her family took a trip away from town.")}
			[/else]
		[/if]
		
		{VOADAR_MESSAGE Ivan (_"Ah! Think of the youngsters! We can't do anything rash when so much depends on our village. There must be some misunderstanding about all this.")}
		{VOADAR_MESSAGE Curryan (_"<i>(Fronws)</i> Just what do you mean, misunderstanding? Unless you're questioning Maple, there's no doubt about what happened.")}
		{VOADAR_MESSAGE Ivan (_"<i>(Scowls)</i>")}
		
		# Second split: Tourists leave if they're here
		[if]
			[have_unit]
				id=Nickieldur
			[/have_unit]
			[then]
				[delay]
					time=1000
				[/delay]
				{VOADAR_MESSAGE Derek (_"Time to go.")}
				{VOADAR_MESSAGE Rayyan (_"Derek are right.")}
				{MOVE_UNIT (id=Derek) 43 8}
				[kill]
					id=Derek
				[/kill]
				{MOVE_UNIT (id=Rayyan) 43 6}
				[delay]
					time=500
				[/delay]
				{VOADAR_STORE_UNIT Rayyan no}
				{VARIABLE Rayyan.unit.facing se}
				[unstore_unit]
					variable=Rayyan.unit
					find_vacant=no
				[/unstore_unit]
				[delay]
					time=1000
				[/delay]
				{VOADAR_MESSAGE Rayyan (_"Nick?")}
				{VOADAR_MESSAGE Maple (_"It's alright honey. This isn't your fight.")}
				{IF_VAR persist.Robert.quest_complete equals yes (
					[then]
						{VOADAR_MESSAGE Nickieldur (_"Sorry, Voadar. Bye, Robert.")}
						{VOADAR_MESSAGE Rayyan (_"Yes, 'Bye.'")}
						{VOADAR_MESSAGE Robert (_"...Bye guys.")}
					[/then]
					[else]
						{VOADAR_MESSAGE Nickieldur (_"Sorry, Voadar.")}
					[/else]
				)}
				{MOVE_UNIT (id=Nickieldur) 43 8}
				[kill]
					id=Nickieldur
				[/kill]
				{MOVE_UNIT (id=Rayyan) 43 8}
				[kill]
					id=Rayyan
				[/kill]
				{CLEAR_VARIABLE Rayyan}
				
				[delay]
					time=1000
				[/delay]
				# Tetaitiel tries to get things back on track:
				{VOADAR_MESSAGE Tetaitiel (_"We must all stay focused until we reach a consensus. We don't know how far Mayor Ronry will go to defend his title, nor is it clear how far each of us will go against him.")}
			[/then]
		[/if]
		
		{VOADAR_MESSAGE Juditha (_"Well I know one thing. I'm not sticking my neck out for a scaly demon. Maple says the mayor wants him for some reason, so why don't we just hand him over! Even use him to bargain over taxes!")}
		{IF_VAR persist.fishers not_equals "only_Frank" (
			[then]
				{VOADAR_MESSAGE Rachael (_"<i>(Gasps)</i> Mother!")}
			[/then]
		)}
		{VOADAR_MESSAGE Nhardril (_"<i>(Getting nervous)</i> Out of the question! Who's to say Ronry won't do something even worse next?")}
		
		# Curryan might leave here:
		{IF_VAR persist.Curryan.quest_complete equals no (
			[then]
				{VOADAR_MESSAGE Curryan (_"Regardless, I think you are being too brash on this one, Nhardril. There are official policies for this kind of thing, and I do not believe that Mayor Ronry can circumvent them.")}
				{VOADAR_MESSAGE Hob (_"What? But we already know he'll kill to get what he wants!")}
				{VOADAR_MESSAGE Curryan (_"<i>(Scoffs)</i> That's enough out of you. Everyone, I'm leaving to the capital straight away, to straighten things out. I suggest you all follow my example of leaving this tavern without delay.")}
				{MOVE_UNIT (id=Curryan) 43 8}
				[kill]
					id=Curryan
				[/kill]
			[/then]
		)}
		
		# This is where it gets really tricky. It's Mrs. Aristo's turn to make a stand.
		# and in the middle of it all, her son might take a stand too. or he might not.
		# or he might not even be here.
		{IF_VAR persist.Mrs_aristo.quest_complete equals yes (
			[then]
				{VOADAR_MESSAGE Mrs_aristo (_"If I may! I stand with Voadar. We must do whatever it takes to remove Mayor Ronry from office.")}
				[if]
					[have_unit]
						id=Robert
					[/have_unit]
					[then]
						{VOADAR_MESSAGE Mrs_aristo (_"You. <i>(Pokes Father Aristo)</i> Take Robert back to the house. I want him safe.")}
						{VOADAR_MESSAGE Father_aristo (_"Hm--? Um, I... yes, of course dear. I wasn't sleeping.")}
						{IF_VAR persist.Robert.quest_complete equals yes (
							[then]
								{VOADAR_MESSAGE Robert (_"Wait! I can take care of myself. We're all seeing this through, together.")}
								{VOADAR_MESSAGE Mrs_aristo (_"Absolutely not! When did--")}
								{VOADAR_MESSAGE Robert (_"TOGETHER. ...As a family.")}
								{VOADAR_MESSAGE Mrs_aristo (_". . .")}
								{VOADAR_MESSAGE Maple (_"We appreciate your support.")}
							[/then]
							[else]
								{VOADAR_MESSAGE Robert (_"...Fine. This way, father.")}
								{MOVE_UNIT (id=Robert) 36 4}
								[kill]
									id=Robert
								[/kill]
								{MOVE_UNIT (id=Father_aristo) 36 4}
								[kill]
									id=Father_aristo
								[/kill]
								{VOADAR_MESSAGE Maple (_"We appreciate your support, Mrs. Aristo.")}
							[/else]
						)}
					[/then]
					[else]
						{VOADAR_MESSAGE Maple (_"We appreciate your support.")}
					[/else]
				[/if]
			[/then]
			[else]
				{VOADAR_MESSAGE Mrs_aristo (_"I'm afraid I side with Juditha. There are better ways to deal with this... <i>(glances at Voadar)</i> ...situation. My family and I are leaving.")}
				{VOADAR_MESSAGE Father_aristo (_"Hm--? Um, I... yes, of course dear. I wasn't sleeping.")}
				{MOVE_UNIT (id=Father_aristo) 36 4}
				[kill]
					id=Father_aristo
				[/kill]
				[if]
					[have_unit]
						id=Robert
					[/have_unit]
					[then]
						{IF_VAR persist.Robert.quest_complete equals yes (
							[then]
								{MOVE_UNIT (id=Mrs_aristo) 39 4}
								{MOVE_UNIT (id=Fifo) 40 3}
								[delay]
									time=1500
								[/delay]
								{VOADAR_MESSAGE Mrs_aristo (_"Robert? I'm waiting.")}
								{VOADAR_MESSAGE Robert (_"No. No! I'm staying here! You've completely misjudged Voadar, and you've misjudged how serious this situation is.")}
								{VOADAR_MESSAGE Mrs_aristo (_"What?! I, When did you start talking to me like that! Out of that door, now!")}
								{VOADAR_MESSAGE Robert (_"I said no. I'm helping Voadar.")}
								{VOADAR_MESSAGE Mrs_aristo (_"...You and I are having long talk about this, as soon as things settle down.")}
								{MOVE_UNIT (id=Mrs_aristo) 36 4}
								[kill]
									id=Mrs_aristo
								[/kill]
								{MOVE_UNIT (id=Fifo) 36 4}
								[kill]
									id=Fifo
								[/kill]
								{VOADAR_MESSAGE Maple (_"Robert, we appreciate your support.")}
							[/then]
							[else]
								{MOVE_UNIT (id=Robert) 36 4}
								[kill]
									id=Robert
								[/kill]
								{MOVE_UNIT (id=Mrs_aristo) 36 4}
								[kill]
									id=Mrs_aristo
								[/kill]
								{MOVE_UNIT (id=Fifo) 36 4}
								[kill]
									id=Fifo
								[/kill]
							[/else]
						)}
					[/then]
					[else]
						{MOVE_UNIT (id=Robert) 36 4}
						[kill]
							id=Robert
						[/kill]
						{MOVE_UNIT (id=Mrs_aristo) 36 4}
						[kill]
							id=Mrs_aristo
						[/kill]
						{MOVE_UNIT (id=Fifo) 36 4}
						[kill]
							id=Fifo
						[/kill]
					[/else]
				[/if]
			[/else]
		)}
				
		# Next is Juditha/Rachael. This one's not quite as bad.
		# Since Maple spoke last in most of the code paths from the block above,
		# there are only two needed cases for transitioning into this one:
		[if]
			[have_unit]
				id=Mrs_aristo
			[/have_unit]
			[or]
				[have_unit]
					id=Robert
				[/have_unit]
			[/or]
			[then]
				{VOADAR_MESSAGE Juditha (_"Well I 'appreciate' that you're out of your mind! Let's go, Rachael.")}
			[/then]
			[else]
				{VOADAR_MESSAGE Juditha (_"She's got the right idea. Let's go, Rachael.")}
			[/else]
		[/if]
		{IF_VAR persist.fishers equals "all" (
			[then]
				{VOADAR_MESSAGE Frank (_"No wait! Please don't go! You, eh... see, Voadar really is better than you think. But that aside, we really we should all stay, for the good of the town!")}
				{VOADAR_MESSAGE Rachael (_"Yes, I'm staying too. We can't turn our backs to this.")}
				{VOADAR_MESSAGE Juditha (_"...You two really do like each other, don't you?")}
				{VOADAR_MESSAGE Juditha (_". . .")}
				{VOADAR_MESSAGE Juditha (_"You'd better make sure he treats you right, Rachael. I'll see things through here, for your sake.")}
			[/then]
		)}
		{IF_VAR persist.fishers equals "not_Juditha" (
			[then]
				{VOADAR_MESSAGE Rachael (_"Mother, please! You remember, it was Voadar who returned our fishing net! Isn't that enough to earn our trust?")}
				{VOADAR_MESSAGE Juditha (_"<i>(Scowls)</i> I'll never trust a monster like that one! We're leaving, now!")}
				{VOADAR_MESSAGE Rachael (_"Well I'm not turning my back on someone who helped us.")}
				{VOADAR_MESSAGE Juditha (_"FINE! You can run chase along after anyone you want! But don't you come crying back to me when someone you 'trust' rips your heart out!")}
				{MOVE_UNIT (id=Juditha) 36 4}
				[kill]
					id=Juditha
				[/kill]
			[/then]
		)}
		{IF_VAR persist.fishers equals "only_Frank" (
			[then]
				{MOVE_UNIT (id=Juditha) 37 5}
				{MOVE_UNIT (id=Rachael) 38 5}
				{VOADAR_MESSAGE Frank (_"No wait! Please don't go! You, eh... see, Voadar really is better than you think! But that aside, we really we should all stay, for the good of the town.")}
				{VOADAR_MESSAGE Juditha (_"Save your sweet talk for someone dumb enough to fall for it!")}
				[delay]
					time=500
				[/delay]
				{VOADAR_STORE_UNIT Rachael no}
				{VARIABLE Rachael.unit.facing se}
				[unstore_unit]
					variable=Rachael.unit
				[/unstore_unit]
				[delay]
					time=1000
				[/delay]
				{VOADAR_STORE_UNIT Rachael no}
				{VARIABLE Rachael.unit.facing nw}
				[unstore_unit]
					variable=Rachael.unit
				[/unstore_unit]
				[delay]
					time=800
				[/delay]
				{MOVE_UNIT (id=Rachael) 36 4}
				[kill]
					id=Rachael
				[/kill]
				{MOVE_UNIT (id=Juditha) 36 4}
				[kill]
					id=Juditha
				[/kill]
				{CLEAR_VARIABLE Rachael}
			[/then]
		)}
		
		# Next up is the smiths
		{IF_VAR persist.smiths.quest_complete equals yes (
			[then]
				{VOADAR_MESSAGE Anatil (_"Well, the taxes alone are enough for Anatus and me teh make a stand! Heh heh! We're with you, Voadar.")}
			[/then]
			[else]
				{VOADAR_MESSAGE Anatus (_"Hurm. Well, I can't stand what's going on with tha' mayor, but... I also can't stand what's going on with you, Nhardril!")}
				{VOADAR_MESSAGE Nhardril (_"I... what?")}
				{VOADAR_MESSAGE Anatil (_"Aye. Yer not using yer head on this one, laddy. Sure, something's got teh be done about Ronry, but he's not the only problem in this village. It's either us or that beast yer standing with, Nhardril! Choose fast!")}
				{VOADAR_MESSAGE Nhardril (_"But... boys! Voadar's on our side with this! <i>(Nervous laugh)</i> Not one of us has more to hold against the mayor!")}
				{VOADAR_MESSAGE Anatus (_"<i>(Shakes head)</i> Well, sorry then. If yeh make it out of this alive, we'll meet you back in the clans, aye?")}
				{MOVE_UNIT (id=Anatil) 43 8}
				[kill]
					id=Anatil
				[/kill]
				{MOVE_UNIT (id=Anatus) 43 8}
				[kill]
					id=Anatus
				[/kill]
				{VOADAR_MESSAGE Nhardril (_"No, boys..! Auch... well, none the less. I'm ready to make a stand!")}
			[/else]
		)}
		
		
		# Vyncent might not be here, but in that case this message will safely be skipped:
		{VOADAR_MESSAGE Vyncent (_"Same here!")}
		# Hob says this no matter what (makes sense regardless of who spoke last)
		{VOADAR_MESSAGE Hob (_"And me!")}
		# Same with these three:
		{VOADAR_MESSAGE Curryan (_"<i>(Sigh)</i> And I. I've seen for myself that Voadar cares about the town, and I see that decisive action is the only option.")}
		{VOADAR_MESSAGE Grigar (_"Hm. I stay! Voadar good. I stay!")}
		{VOADAR_MESSAGE Leonna (_"I've known all along that I would side with Voadar! It's the least I could do, after all that he's... <i>sniff sniff...</i>")}
		
		# Ivan is acting fishy:
		{VOADAR_MESSAGE Ivan (_"Now everyone hold on a danged minute! You don't actually want to start a fight, do you?? Mayor Ronry could send for soldiers from the capital before you know it! You're all out of your minds!")}
		
		# Almost finally, the gladiator chiefs:
		{IF_VAR persist.gladiators.quest_complete equals yes (
			[then]
				{VOADAR_MESSAGE Tetaitiel (_"No, Maple is right. It is too late for negotiation, and the mayor must be dealt with harshly. Voadar, we will lend you our bows if need be.")}
			[/then]
			[else]
				{VOADAR_MESSAGE Tetaitiel (_"No, Maple is right. The mayor should be dealt with harshly. However...")}
				{VOADAR_MESSAGE Commodir (_"Voadar, what did you do with the charm we gave you?")}
				{VOADAR_MESSAGE Tetaitiel (_"It was not given lightly, and in the wrong hands is dangerous to our tribe, which is already in troubled times. So now, we finally close the arena and bid Raplice farewell. ")}
				{MOVE_UNIT (id=Commodir) 43 8}
				[kill]
					id=Commodir
				[/kill]
				{MOVE_UNIT (id=Tetaitiel) 43 8}
				{VOADAR_MESSAGE Maple (_"Tetaitiel! ...I'm sorry.")}
				{VOADAR_MESSAGE Tetaitiel (_"<i>(Smiles)</i> Farewell, Maple.")}
				[kill]
					id=Tetaitiel
				[/kill]
				[delay]
					time=1000
				[/delay]
				{VOADAR_MESSAGE Nhardril (_"<i>(Shakes head)</i>")}
			[/else]
		)}
		
		{VOADAR_MESSAGE Gwain (_"Well, boss, that just leaves us. Before I say anthing else... what are your orders?")}
		{VOADAR_MESSAGE George (_"I... well, it seems--")}
		{VOADAR_MESSAGE_NARRATOR (_"<span size='xx-large'><b>BOOM BOOM BOOM</b></span>")}
		[message]
			speaker=narrator
			caption=_"Unfamiliar voice"
			# no image
			message=_"Open this door! This is Sir Yorksha, captain of Her Magesty's Twelfth Regiment!"
		[/message]
		[delay]
			time=2000
		[/delay]
		[if]
			[have_unit]
				id=Mrs_aristo
			[/have_unit]
			[then]
				{VOADAR_MESSAGE Mrs_aristo (_"Best consider quickly, general. The rest of us have chosen our side.")}
			[/then]
			[else]
				[if]
					[have_unit]
						id=Anatil
					[/have_unit]
					[then]
						{VOADAR_MESSAGE Anatil (_"<i>(Grimly)</i> Better make your decision fast, George. The rest of us here are making good on our word.")}
					[/then]
					[else]
						{VOADAR_MESSAGE Nhardril (_"<i>(Grimly)</i> Better make your decision fast, George. The rest of us here are making good on our word.")}
					[/else]
				[/if]
			[/else]
		[/if]
	[/event]
	
	
    
    
    
    # of course you lose if Voadar dies 
    [event]
        name=die
        id=die_lose_game
        [filter]
            id=Voadar
        [/filter]
		#TODO defeat dialog?
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    
    # Place images, decorations, and labels
    [event]
        name=prestart
        id=tutorial_place_images
        
        {PLACE_IMAGE "scenery/leanto.png" 15 10}
        {PLACE_IMAGE "items/enhantress-statue-e-normal.png" 12 11}
    [/event]

[/scenario]
