#textdomain wesnoth-voadar
[scenario]
    
    id=3_Valor
    name= _ "Valor"
    next_scenario=null
    map_data="{~add-ons/Voyage_of_a_Drake/maps/valor.map}"
    turns=-1
    victory_when_enemies_defeated=no
    
    # Temporary music
	# (will be changed during the intro cut-scene)
    {INTRO_AND_SCENARIO_MUSIC revelation.ogg vengeful.ogg}

    # The story
    [story]
        [part]
            story= _ "Nhardril and Maple quickly passed around word of another town meeting. Everyone's reactions were the same: nervous listening and uneasy agreement to attend. The next evening, the atmosphere was tense like a drawn bowstring as the villagers gathered."
            background="story/landscape-hills-01.jpg"
        [/part]
        [part]
            story= _ "Anxious small talk buzzed through the crowded tavern until Nhardril called for everyone's attention. A stifling quiet filled the room, penetrated only by Maple as she related what had happened to her and Voadar. By the time her brief recollection ended, the tense air was beginning to crack. Angry whispers were followed by angry yells, and it seemed the village was finally willing to take action."
            background="story/landscape-hills-01.jpg"
        [/part]
    [/story]

    # Set the objectives
#define VALOR_OBJECTIVES EXTRA_NOTE
	[objectives]
		[objective]
			description= _ "Drive off the royal army"
			condition=win
		[/objective]
		[objective]
			description=_"Death of Voadar"
			condition=lose
		[/objective]
		[note]
			description=_"In the heat of battle, you don't have time to use any items"
		[/note]
		{EXTRA_NOTE}
	[/objectives]
#enddef
    [event]
        name=prestart
		{IF_VAR persist.Voadar.has_potion equals yes (
			[then]
				{VALOR_OBJECTIVES (
					[note]
						description=_"However, the instant heal potion you bought from Klippy is still available"
					[/note]
				)}
			[/then]
			[else]
				{VALOR_OBJECTIVES ()}
			[/else]
		)}
    [/event]
#undef VALOR_OBJECTIVES
	
	# not using the macro to avoid having a sound effect every turn
    [time]
        id=dusk_hour
        name= _ "Dusk"
        image=misc/time-schedules/tod-schedule-24hrs.png~CROP(250,156,125,39)
        red=10
        green=-20
        blue=-35
    [/time]
	
	[event]
		name=prestart
		[time_area]
			x=34-51
			{INDOORS}
		[/time_area]
	[/event]

    # The player's side
    [side]
        {VOADAR_SIDE_BASICS}
        side=1
        controller=human
        gold=0
        fog=yes
        shroud=yes
        team_name=raplice
        color=orange
        {FLAG_VARIANT loyalist}
    [/side]
	
    # Enemy's side
    [side]
        {VOADAR_SIDE_BASICS}
        side=2
        team_name=foes
        color=teal
        shroud=no
		fog=no
        gold=500
        [ai]
            aggression=1
            caution=.35
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=.9
            [/goal]
        [/ai]
        {FLAG_VARIANT loyalist}
    [/side]

    # Make sure units are healable & full hp
	# and by full hp, i mean double the normal (makes it reasonable to keep
	# most characters alive without making the fight too easy)
	[event]
		name=unit placed
		id=units_are_healable
		first_time_only=no
        [modify_unit]
            [filter]
                x,y=$x1|,$y1
				[not]
					[filter_wml]
						[variables]
							doubled_hp=yes
						[/variables]
					[/filter_wml]
				[/not]
            [/filter]
            [status]
                unhealable=no
				poisoned=no
				slowed=no
            [/status]
			[variables]
				doubled_hp=yes
			[/variables]
			max_hitpoints=$($unit.max_hitpoints * 2)
			hitpoints=$($unit.max_hitpoints * 2)
            # also, there is no such thing as upkeep:
            upkeep=loyal
        [/modify_unit]
		# Also, everyone gets vision set to 0. It helps part of the cutscene, 
		# and doesn't affect gameplay because the AI side has no fog/shroud (and
		# I think it ignores them anyway) and Voadar will still have his huge vision
		[modify_unit]
			[filter]
				x,y=$x1,$y1
				[not]
					id=Voadar
				[/not]
			[/filter]
			vision=0
		[/modify_unit]
	[/event]
    
    # Beginning shroud placement
	[event]
		name=prestart
		[place_shroud]
			side=1
			x=0-33
		[/place_shroud]
	[/event]
	
	
	# This one is just a ton of different prestart things that must happen in sequence
	[event]
		name=prestart
		################################################
		# a debug tool: change the persistent variables just before the scenario starts
		# to use, use this debug command before ending 2_Voyage:
		# :set_var persist.change_vars=yes
		################################################
		[if]
			[variable]
				name=persist.change_vars
				equals=yes
			[/variable]
			[then]
				{VARIABLE break no}
				[while]
					[variable]
						name=break
						equals=no
					[/variable]
					[do]
						[message]
							speaker=narrator
							image=wesnoth-icon.png
							caption=_"Setup persist vars"
							[option]
								label=_"Ready - begin level"
								[command]
									{VARIABLE break yes}
								[/command]
							[/option]
							[option]
								label=_"Inspect"
								[command]
									[inspect]
									[/inspect]
								[/command]
							[/option]
							[option]
								label=_"Change var"
								[command]
									[message]
										speaker=narrator
										image=wesnoth-icon.png
										caption=_"Variable name"
										[text_input]
											variable=var_name
											text="persist."
										[/text_input]
									[/message]
									[message]
										speaker=narrator
										image=wesnoth-icon.png
										caption=_"New value"
										[text_input]
											variable=new_val
											text="yes"
										[/text_input]
									[/message]
									{VARIABLE $var_name| $new_val|}
								[/command]
							[/option]
						[/message]
					[/do]
				[/while]
				{CLEAR_VARIABLE break,var_name,new_val}
			[/then]
		[/if]
	
		# unpack a couple of the persist variables:
		{CLEAR_VARIABLE Voadar}
		{VARIABLE Voadar.has_potion $persist.Voadar.has_potion|}
		{VARIABLE Voadar.ranged_attack_unlocked $persist.Voadar.ranged_attack_unlocked|}

		################################################
		# Place all the characters
		# Just make each unit, and put it in a generic position
		#
		# choosing which ones appear/stick around to help comes next
		################################################
		
		{VARIABLE persist.Voadar.unit.facing sw}
		[unstore_unit]
			variable=persist.Voadar.unit
			x,y=45,3
			fire_event=yes
		[/unstore_unit]
		
#define VOADAR_UNIT TYPE ID NAME X Y FACING TRAIT_ONE TRAIT_TWO WML
    [unit]
        id={ID}
        name={NAME}
        x,y={X},{Y}
        type={TYPE}
        side=2
        facing={FACING}
        [modifications]
            {TRAIT_{TRAIT_ONE}}
            {TRAIT_{TRAIT_TWO}}
        [/modifications]
        {WML}
    [/unit]
#enddef
		# What is the NE in front of each unit type?
		# "No Event"
		# The main unit types have the NE versions as [base_unit]s, but add
		# all kinds of horrid events for controlling the schedules
        {VOADAR_UNIT "NE Business Dwarf" "Nhardril" (_"Nhardril") 46 3 sw INTELLIGENT HEALTHY ()}
        {VOADAR_UNIT "NE Voadar Elvish Druid" "Maple" (_"Maple") 47 4 sw QUICK DEXTROUS ()}
        {VOADAR_UNIT "NE Voadar Dwarvish Runesmith" "Anatus" (_"Anatus") 41 7 se STRONG HEALTHY ()}
        {VOADAR_UNIT "NE Voadar Dwarvish Steelclad" "Anatil" (_"Anatil") 42 6 se RESILIENT INTELLIGENT ()}
        {VOADAR_UNIT "NE Village Elder" "Ivan" (_"Ivan") 40 7 se AGED RESILIENT ()}
        {VOADAR_UNIT "NE Village Preacher" "Father_aristo" (_"Father Aristo") 39 4 se INTELLIGENT WEAK ()}
        {VOADAR_UNIT "NE Dog" "Fifo" (_"Fifo") 41 3 se STRONG INTELLIGENT ()}
        {VOADAR_UNIT "NE Aristocrat" "Mrs_aristo" (_"Mrs. Aristo") 40 3 se INTELLIGENT WEAK (gender=female)}
        {VOADAR_UNIT "NE Young Aristocrat" "Robert" (_"Robert") 38 4 se INTELLIGENT STRONG ()}
        {VOADAR_UNIT "NE Village Tramp" "Klippy" (_"Klippy") 42 7 se QUICK INTELLIGENT (gender=female)}
        {VOADAR_UNIT "NE Carpenter" "Frank" (_"Frank") 39 6 se INTELLIGENT STRONG ()}
        {VOADAR_UNIT "NE Village Introvert" "Juditha" (_"Juditha") 40 6 se RESILIENT STRONG (gender=female)}
        {VOADAR_UNIT "NE Young Fisher" "Rachael" (_"Rachael") 40 5 se INTELLIGENT QUICK (gender=female)}
        {VOADAR_UNIT "NE Postmaster" "Curryan" (_"Curryan") 42 4 se QUICK LOYAL (gender=female)}
        {VOADAR_UNIT "NE Groom" "Hob" (_"Hob") 41 5 se DIM WEAK ()}
        {VOADAR_UNIT "NE Cobbler" "Leonna" (_"Leonna") 40 4 se QUICK DEXTROUS ()}
        {VOADAR_UNIT "NE Seasoned Farmer" "Vyncent" (_"Vyncent") 42 3 se STRONG QUICK ()}
        {VOADAR_UNIT "NE Voadar Elvish Champion" "Commodir" (_"Commodir") 44 5 se STRONG QUICK ()}
        {VOADAR_UNIT "NE Voadar Elvish Sharpshooter" "Tetaitiel" (_"Tetaitiel") 44 6 se DEXTROUS INTELLIGENT (gender=female)}
        {VOADAR_UNIT "NE Voadar Orcish Crossbowman" "Grigar" (_"Grigar") 37 6 se RESILIENT QUICK ()}
		
        {VOADAR_UNIT "NE Voadar Pikeman" "Harold" (_"Harold") 43 2 se RESILIENT QUICK ()}
        {VOADAR_UNIT "NE Voadar General" "George" (_"George") 43 3 se STRONG LOYAL ()}
        {VOADAR_UNIT "NE Voadar Longbowman" "Gwain" (_"Gwain") 42 2 se STRONG DEXTROUS()}
		
        {VOADAR_UNIT "NE Elvish Tourist" "Nickieldur" (_"Nickieldur") 45 5 se DEXTROUS QUICK ()}
        {VOADAR_UNIT "NE Human Tourist" "Derek" (_"Derek") 46 5 se STRONG RESILIENT ()}
        {VOADAR_UNIT "NE Dunefolk Tourist" "Rayyan" (_"Rayyan") 44 4 se QUICK STRONG ()}
#undef VOADAR_UNIT
		
# We'll be using this periodically
#define VOADAR_CHANGE_SIDE ID
	[modify_unit]
		[filter]
			id={ID}
		[/filter]
		side=1
	[/modify_unit]
#enddef
		
		{VOADAR_CHANGE_SIDE Nhardril}
		{VOADAR_CHANGE_SIDE Maple}
		
		# Maple was made pretty weak for the Dogifforo fight, she needs a powerup for this one:
		[modify_unit]
			[filter]
				id=Maple
			[/filter]
			[effect]
				apply_to=attack
				name=staff
				set_damage=8
			[/effect]
			[effect]
				apply_to=attack
				name=entangle
				set_damage=6
				set_number=3
			[/effect]
			[effect]
				apply_to=new_attack
				name=thorns
				description=_"thorns"
				type=pierce
				[specials]
					{WEAPON_SPECIAL_MAGICAL}
				[/specials]
				damage=8
				number=3
				range=ranged
			[/effect]
		[/modify_unit]
		
		# also, she and Father Aristo can be healers now
		[modify_unit]
			[filter]
				id=Maple
			[/filter]
			[effect]
				apply_to=new_ability
				[abilities]
					{ABILITY_UNPOISON}
					[heals]
						value=16
						id=healing
						affect_allies=yes
						name= _ "heals +16"
						female_name= _ "female^heals +16"
						description= _ "This unit combines herbal remedies with magic to heal units more quickly than is normally possible on the battlefield.

A unit cared for by this healer may heal up to 16 HP per turn, or stop poison from taking effect for that turn.
This ability will not cure an affected unit of poison, however, only delay its effect."
						affect_self=no
						poison=slowed
						[affect_adjacent]
						[/affect_adjacent]
					[/heals]
				[/abilities]
			[/effect]
		[/modify_unit]
		[modify_unit]
			[filter]
				id=Father_aristo
			[/filter]
			[effect]
				apply_to=new_ability
				[abilities]
					{ABILITY_UNPOISON}
					[heals]
						value=16
						id=healing
						affect_allies=yes
						name= _ "heals +16"
						female_name= _ "female^heals +16"
						description= _ "This unit combines herbal remedies with magic to heal units more quickly than is normally possible on the battlefield.

A unit cared for by this healer may heal up to 16 HP per turn, or stop poison from taking effect for that turn.
This ability will not cure an affected unit of poison, however, only delay its effect."
						affect_self=no
						poison=slowed
						[affect_adjacent]
						[/affect_adjacent]
					[/heals]
				[/abilities]
			[/effect]
		[/modify_unit]
		
		# and Robert might have a sword:
		{IF_VAR persist.Robert.quest_complete equals yes (
			[then]
				{VOADAR_STORE_UNIT Robert no}
				{VARIABLE Robert.unit.attack[0].name "short sword"}
				{VARIABLE Robert.unit.attack[0].description (_"short sword")}
				{VARIABLE Robert.unit.attack[0].icon attacks/sword-human-short.png}
				{VARIABLE Robert.unit.attack[0].type blade}
				{VARIABLE Robert.unit.attack[0].damage 10}
				{VARIABLE Robert.unit.attack[0].number 3}
				[unstore_unit]
					variable=Robert.unit
					find_vacant=no
				[/unstore_unit]
			[/then]
		)}
		
		################################################
		# Next, decide which units are present when the scenario first starts
		# Some will reappear later, but that is dealt with at the same time as dialog
		################################################
		
		# the guards will appear shortly
		{VOADAR_STORE_UNIT Harold yes}
		{VOADAR_STORE_UNIT Gwain yes}
		{VOADAR_STORE_UNIT George yes}
		
		# tourists only appear initially if they aren't going to help
		{IF_VAR persist.Nickieldur.quest_complete equals yes (
			[then]
				{VOADAR_STORE_UNIT Rayyan yes}
				{VOADAR_STORE_UNIT Nickieldur yes}
				{VOADAR_STORE_UNIT Derek yes}
				# additionally, if Robert has befriended them, he'll show up when they do
				{IF_VAR persist.Robert.quest_complete equals yes (
					[then]
						{VOADAR_STORE_UNIT Robert yes}
						# and let's not waste that spot
						{TELEPORT_UNIT (id=Fifo) 38 4}
					[/then]
				)}
			[/then]
		)}
		
		# These three only show up at all if they do help
		{IF_VAR persist.Leonna.quest_complete equals no (
			[then]
				[kill]
					id=Leonna
				[/kill]
			[/then]
		)}
		{IF_VAR persist.Grigar.quest_complete equals no (
			[then]
				[kill]
					id=Grigar
				[/kill]
			[/then]
		)}
		{IF_VAR persist.farmers.quest_complete equals no (
			[then]
				[kill]
					id=Vyncent
				[/kill]
			[/then]
		)}
		
	[/event]
	
	################################################
	# Next: The stuff that hasn't been done yet
	# yep that was pretty vague
	# Think of this long section as the opening cutscene.
	# Characters come and go, and there are a ton of messages
	################################################
	[event]
		name=start
		
		#
		# An overview of how the conversation should be shaped
		# High energy, accusations (easy part, since this script is more or 
		#	less independent of whose support you have)
		# Sudden crash, apathy/fear begin to set back in
		# 	(explain people who aren't helping, or people who only need to say
		# 	 say something if they're leaving)
		# Rise as supporters state their stance, ending with people who only
		# 	say things when they help
		# Then the military arrives.
		#
		
		
		[unstore_unit]
			variable=Harold.unit
			x,y=36,4
		[/unstore_unit]
		{MOVE_UNIT (id=Harold) 43 2}
		{VOADAR_MESSAGE Harold (_"<i>(Scowls)</i> Just like I thought...")}
		[unstore_unit]
			variable=George.unit
			x,y=36,4
		[/unstore_unit]
		{MOVE_UNIT (id=George) 43 3}
		[unstore_unit]
			variable=Gwain.unit
			x,y=36,4
		[/unstore_unit]
		{MOVE_UNIT (id=Gwain) 42 2}
		{CLEAR_VARIABLE George}
		{CLEAR_VARIABLE Harold}
		{CLEAR_VARIABLE Gwain}
		
		{VOADAR_MESSAGE George (_"<i>Oh no...</i> Gentlemen, please! Not this again!")}
		{VOADAR_MESSAGE_RIGHT Nhardril (_"Sorry, George. It's about more than taxes, now.")}
		{VOADAR_MESSAGE Mrs_aristo (_"Maple says that Dogifforo has admitted to murdering Cadameron! On orders from Mayor Ronry, no less!")}
		{VOADAR_MESSAGE Anatil (_"Aye, and we all know she's not one to tell a lie!")}
		{VOADAR_MESSAGE Frank (_"That's right! The mayor's been acting shady long enough that there isn't much reason to doubt, is there?")}
		{VOADAR_MESSAGE Juditha (_"<i>(Sneers)</i> Just how much did you already know about this, 'General?'")}
		{VOADAR_MESSAGE George (_"I, nothing, of course! All of you know better than to think I'd stand for something like that, but nevertheless--")}
		{VOADAR_MESSAGE Anatus (_"Nevertheless! Nevertheless nothing! Of course you didn't know more about this than any o' the rest o' us, but ye' best not be trying to defend Ronry, neither!")}
		{VOADAR_MESSAGE Gwain (_"I... George, I think they're right. And we couldn't let those taxes go on forever, anyway.")}
		# Vyncent might not be here, but in that case this message will safely be skipped:
		{VOADAR_MESSAGE Vynent (_"I say we march straight to the town hall and kick him out! By force, if that's what it takes!")}
		
		# Klippy slips out:
		{MOVE_UNIT (id=Klippy) 43 8}
		[kill]
			id=Klippy
		[/kill]
		
		{VOADAR_MESSAGE Commodir (_"No one can deny the need for action, whatever that might entail.")}
		{VOADAR_MESSAGE_RIGHT Nhardril(_"We all know what has to be done! Aye???")}
		
		{REPLACE_SCENARIO_MUSIC silence.ogg}
		[delay]
			time=3000
		[/delay]
		{VOADAR_MESSAGE Ivan (_"Well, maybe we're just being a wee bit hasty here, eh?")}
		[delay]
			time=3000
		[/delay]
		{REPLACE_SCENARIO_MUSIC suspense.ogg}
		
		# First split: explain farmers:
		{VOADAR_MESSAGE Mrs_aristo (_"Where is Pema? She's a respectable lady, I want her thoughts.")}
		[if]
			[have_unit]
				id=Vyncent
			[/have_unit]
			[then]
				{VOADAR_CHANGE_SIDE Vyncent}
				{VOADAR_MESSAGE Vyncent (_"She... she's with the kids, somewhere safe. But... but she agrees with me! We can't let Ronry keep getting his way!")}
			[/then]
			[else]
				{VOADAR_MESSAGE Maple (_"She... she said she needed to prioritize the children. Her family took a trip away from town.")}
			[/else]
		[/if]
		
		{VOADAR_MESSAGE Ivan (_"Ah! Think of the youngsters! We can't do anything rash when so much depends on our village. There must be some misunderstanding about all this.")}
		{VOADAR_MESSAGE Curryan (_"<i>(Fronws)</i> Just what do you mean, misunderstanding? Unless you're questioning Maple, there's no doubt about what happened.")}
		{VOADAR_MESSAGE Ivan (_"<i>(Scowls)</i>")}
		
		# Second split: Tourists leave if they're here
		[if]
			[have_unit]
				id=Nickieldur
			[/have_unit]
			[then]
				[delay]
					time=1000
				[/delay]
				{VOADAR_MESSAGE Derek (_"Time to go.")}
				{VOADAR_MESSAGE Rayyan (_"Derek are right.")}
				{MOVE_UNIT (id=Derek) 43 8}
				[kill]
					id=Derek
				[/kill]
				{MOVE_UNIT (id=Rayyan) 43 6}
				[delay]
					time=500
				[/delay]
				{VOADAR_FACE Rayyan se}
				[delay]
					time=1000
				[/delay]
				{VOADAR_MESSAGE Rayyan (_"Nick?")}
				{VOADAR_MESSAGE_RIGHT Maple (_"It's alright honey. This isn't your fight.")}
				{IF_VAR persist.Robert.quest_complete equals yes (
					[then]
						{VOADAR_MESSAGE Nickieldur (_"Sorry, Voadar. Bye, Robert.")}
						{VOADAR_MESSAGE Rayyan (_"Yes, 'Bye.'")}
						{VOADAR_MESSAGE Robert (_"...Bye guys.")}
					[/then]
					[else]
						{VOADAR_MESSAGE Nickieldur (_"Sorry, Voadar.")}
					[/else]
				)}
				{MOVE_UNIT (id=Nickieldur) 43 8}
				[kill]
					id=Nickieldur
				[/kill]
				{MOVE_UNIT (id=Rayyan) 43 8}
				[kill]
					id=Rayyan
				[/kill]
				
				[delay]
					time=1000
				[/delay]
				# Tetaitiel tries to get things back on track:
				{VOADAR_MESSAGE Tetaitiel (_"We must all stay focused until we reach a consensus. We don't know how far Mayor Ronry will go to defend his title, nor is it clear how far each of us will go against him.")}
			[/then]
		[/if]
		
		{VOADAR_MESSAGE Juditha (_"Well I know one thing. I'm not sticking my neck out for a scaly demon. Maple says the mayor wants him for some reason, so why don't we just hand him over! Even use him to bargain over taxes!")}
		{IF_VAR persist.fishers not_equals "only_Frank" (
			[then]
				{VOADAR_MESSAGE Rachael (_"<i>(Gasps)</i> Mother!")}
			[/then]
		)}
		{VOADAR_MESSAGE Nhardril (_"<i>(Getting nervous)</i> Out of the question! Who's to say Ronry won't do something even worse next?")}
		
		# Curryan might leave here:
		{IF_VAR persist.Curryan.quest_complete equals no (
			[then]
				{VOADAR_MESSAGE Curryan (_"Regardless, I think you are being too brash on this one, Nhardril. There are official policies for this kind of thing, and I do not believe that Mayor Ronry can circumvent them.")}
				{VOADAR_CHANGE_SIDE Hob}
				{VOADAR_MESSAGE Hob (_"What? But we already know he'll kill to get what he wants!")}
				{VOADAR_MESSAGE Curryan (_"<i>(Scoffs)</i> That's enough out of you. Everyone, I'm leaving to the capital straight away, to straighten things out. I suggest you all follow my example of leaving this tavern without delay.")}
				{MOVE_UNIT (id=Curryan) 43 8}
				[kill]
					id=Curryan
				[/kill]
			[/then]
		)}
		
		# This is where it gets really tricky. It's Mrs. Aristo's turn to make a stand.
		# and in the middle of it all, her son might take a stand too. or he might not.
		# or he might not even be here.
		{IF_VAR persist.Mrs_aristo.quest_complete equals yes (
			[then]
				{VOADAR_CHANGE_SIDE Mrs_aristo}
				{VOADAR_CHANGE_SIDE Fifo}
				{VOADAR_MESSAGE Mrs_aristo (_"If I may! I stand with Voadar. We must do whatever it takes to remove Mayor Ronry from office.")}
				[if]
					[have_unit]
						id=Robert
					[/have_unit]
					[then]
						{VOADAR_MESSAGE Mrs_aristo (_"You. <i>(Pokes Father Aristo)</i> Take Robert back to the house. I want him safe.")}
						{VOADAR_MESSAGE Father_aristo (_"Hm--? Um, I... yes, of course dear. I wasn't sleeping.")}
						{IF_VAR persist.Robert.quest_complete equals yes (
							[then]
								{VOADAR_MESSAGE Robert (_"Wait! I can take care of myself. We're all seeing this through, together.")}
								{VOADAR_MESSAGE Mrs_aristo (_"Absolutely not! When did--")}
								{VOADAR_CHANGE_SIDE Robert}
								{VOADAR_MESSAGE Robert (_"TOGETHER. ...As a family.")}
								{VOADAR_MESSAGE Mrs_aristo (_". . .")}
								{VOADAR_CHANGE_SIDE Father_aristo}
								{VOADAR_MESSAGE_RIGHT Maple (_"We appreciate your support.")}
							[/then]
							[else]
								{VOADAR_MESSAGE Robert (_"...Fine. This way, father.")}
								{MOVE_UNIT (id=Robert) 36 4}
								[kill]
									id=Robert
								[/kill]
								{MOVE_UNIT (id=Father_aristo) 36 4}
								[kill]
									id=Father_aristo
								[/kill]
								{VOADAR_MESSAGE_RIGHT Maple (_"We appreciate your support, Mrs. Aristo.")}
							[/else]
						)}
					[/then]
					[else]
						{VOADAR_CHANGE_SIDE Father_aristo}
						{VOADAR_MESSAGE_RIGHT Maple (_"We appreciate your support.")}
					[/else]
				[/if]
			[/then]
			[else]
				{VOADAR_MESSAGE Mrs_aristo (_"I'm afraid I side with Juditha. There are better ways to deal with this... <i>(glances at Voadar)</i> ...situation. My family and I are leaving.")}
				{VOADAR_MESSAGE Father_aristo (_"Hm--? Um, I... yes, of course dear. I wasn't sleeping.")}
				{MOVE_UNIT (id=Father_aristo) 36 4}
				[kill]
					id=Father_aristo
				[/kill]
				[if]
					[have_unit]
						id=Robert
					[/have_unit]
					[then]
						{IF_VAR persist.Robert.quest_complete equals yes (
							[then]
								{MOVE_UNIT (id=Mrs_aristo) 39 4}
								{MOVE_UNIT (id=Fifo) 40 3}
								[delay]
									time=1500
								[/delay]
								{VOADAR_MESSAGE Mrs_aristo (_"Robert? I'm waiting.")}
								{VOADAR_MESSAGE Robert (_"No. No! I'm staying here! You've completely misjudged Voadar, and you've misjudged how serious this situation is.")}
								{VOADAR_MESSAGE Mrs_aristo (_"What?! I, When did you start talking to me like that! Out of that door, now!")}
								{VOADAR_CHANGE_SIDE Robert}
								{VOADAR_MESSAGE Robert (_"I said no. I'm helping Voadar.")}
								{VOADAR_MESSAGE Mrs_aristo (_"...You and I are having long talk about this, as soon as things settle down.")}
								{MOVE_UNIT (id=Mrs_aristo) 36 4}
								[kill]
									id=Mrs_aristo
								[/kill]
								{MOVE_UNIT (id=Fifo) 36 4}
								[kill]
									id=Fifo
								[/kill]
								{VOADAR_MESSAGE_RIGHT Maple (_"Robert, we appreciate your support.")}
							[/then]
							[else]
								{MOVE_UNIT (id=Robert) 36 4}
								[kill]
									id=Robert
								[/kill]
								{MOVE_UNIT (id=Mrs_aristo) 36 4}
								[kill]
									id=Mrs_aristo
								[/kill]
								{MOVE_UNIT (id=Fifo) 36 4}
								[kill]
									id=Fifo
								[/kill]
							[/else]
						)}
					[/then]
					[else]
						{MOVE_UNIT (id=Mrs_aristo) 36 4}
						[kill]
							id=Mrs_aristo
						[/kill]
						{MOVE_UNIT (id=Fifo) 36 4}
						[kill]
							id=Fifo
						[/kill]
					[/else]
				[/if]
			[/else]
		)}
				
		# Next is Juditha/Rachael. This one's not quite as bad.
		# Since Maple spoke last in most of the code paths from the block above,
		# there are only two needed cases for transitioning into this one:
		[if]
			[have_unit]
				id=Mrs_aristo
			[/have_unit]
			[or]
				[have_unit]
					id=Robert
				[/have_unit]
			[/or]
			[then]
				{VOADAR_MESSAGE Juditha (_"Well I 'appreciate' that you're out of your mind! Let's go, Rachael.")}
			[/then]
			[else]
				{VOADAR_MESSAGE Juditha (_"She's got the right idea. Let's go, Rachael.")}
			[/else]
		[/if]
		{IF_VAR persist.fishers equals "all" (
			[then]
				{VOADAR_CHANGE_SIDE Frank}
				{VOADAR_MESSAGE Frank (_"No wait! Please don't go! You, eh... see, Voadar really is better than you think. But that aside, we really we should all stay, for the good of the town!")}
				{VOADAR_CHANGE_SIDE Rachael}
				{VOADAR_MESSAGE Rachael (_"Yes, I'm staying too. We can't turn our backs to this.")}
				{VOADAR_MESSAGE Juditha (_"...You two really do like each other, don't you?")}
				{VOADAR_MESSAGE Juditha (_". . .")}
				{VOADAR_CHANGE_SIDE Juditha}
				{VOADAR_MESSAGE Juditha (_"You'd better make sure he treats you right, Rachael. I'll see things through here, for your sake.")}
			[/then]
		)}
		{IF_VAR persist.fishers equals "not_Juditha" (
			[then]
				{VOADAR_MESSAGE Rachael (_"Mother, please! You remember, it was Voadar who returned our fishing net! Isn't that enough to earn our trust?")}
				{VOADAR_MESSAGE Juditha (_"<i>(Scowls)</i> I'll never trust a monster like that one! We're leaving, now!")}
				{VOADAR_CHANGE_SIDE Rachael}
				{VOADAR_MESSAGE Rachael (_"Well I'm not turning my back on someone who helped us.")}
				{VOADAR_MESSAGE Juditha (_"FINE! You can run chase along after anyone you want! But don't you come crying back to me when someone you 'trust' rips your heart out!")}
				{MOVE_UNIT (id=Juditha) 36 4}
				[kill]
					id=Juditha
				[/kill]
				{VOADAR_CHANGE_SIDE Frank}
				{VOADAR_MESSAGE Frank (_"Thanks for staying, Rachael.")}
			[/then]
		)}
		{IF_VAR persist.fishers equals "only_Frank" (
			[then]
				{MOVE_UNIT (id=Juditha) 37 5}
				{MOVE_UNIT (id=Rachael) 38 5}
				{VOADAR_CHANGE_SIDE Frank}
				{VOADAR_MESSAGE Frank (_"No wait! Please don't go! You, eh... see, Voadar really is better than you think! But that aside, we really we should all stay, for the good of the town.")}
				{VOADAR_MESSAGE Juditha (_"Save your sweet talk for someone dumb enough to fall for it!")}
				[delay]
					time=500
				[/delay]
				{VOADAR_FACE Rachael se}
				[delay]
					time=1000
				[/delay]
				{VOADAR_FACE Rachael nw}
				[delay]
					time=600
				[/delay]
				{MOVE_UNIT (id=Rachael) 36 4}
				[kill]
					id=Rachael
				[/kill]
				{MOVE_UNIT (id=Juditha) 36 4}
				[kill]
					id=Juditha
				[/kill]
			[/then]
		)}
		
		# Next up is the smiths
		{IF_VAR persist.smiths.quest_complete equals yes (
			[then]
				{VOADAR_CHANGE_SIDE Anatil}
				{VOADAR_CHANGE_SIDE Anatus}
				{VOADAR_MESSAGE Anatil (_"Well, the taxes alone are enough for Anatus and me teh make a stand! Heh heh! We're with you, Voadar.")}
			[/then]
			[else]
				{VOADAR_MESSAGE Anatus (_"Hurm. Well, I can't stand what's going on with tha' mayor, but... I also can't stand what's going on with you, Nhardril!")}
				{VOADAR_MESSAGE_RIGHT Nhardril (_"I... what?")}
				{VOADAR_MESSAGE Anatil (_"Aye. Yer not using yer head on this one, laddy. Sure, something's got teh be done about Ronry, but he's not the only problem in this village. It's either us or that beast yer standing with, Nhardril! Choose fast!")}
				{VOADAR_MESSAGE_RIGHT Nhardril (_"But... boys! Voadar's on our side with this! <i>(Nervous laugh)</i> Not one of us has more to hold against the mayor!")}
				{VOADAR_MESSAGE Anatus (_"<i>(Shakes head)</i> Well, sorry then. If yeh make it out of this alive, we'll meet you back in the clans, aye?")}
				{MOVE_UNIT (id=Anatil) 43 8}
				[kill]
					id=Anatil
				[/kill]
				{MOVE_UNIT (id=Anatus) 43 8}
				[kill]
					id=Anatus
				[/kill]
				{VOADAR_MESSAGE_RIGHT Nhardril (_"No, boys..! Auch... well, none the less. I'm ready to make a stand!")}
			[/else]
		)}
		
		
		# Vyncent might not be here, but in that case this message will safely be skipped:
		{VOADAR_MESSAGE Vyncent (_"Same here!")}
		# Hob says this no matter what (makes sense regardless of who spoke last)
		{VOADAR_CHANGE_SIDE Hob}
		{VOADAR_MESSAGE Hob (_"And me!")}
		[if]
			[have_unit]
				id=Curryan
			[/have_unit]
			[then]
				{VOADAR_CHANGE_SIDE Curryan}
				{VOADAR_MESSAGE Curryan (_"<i>(Sigh)</i> And I. I've seen for myself that Voadar cares about the town, and I see that decisive action is the only option.")}
			[/then]
		[/if]
		[if]
			[have_unit]
				id=Grigar
			[/have_unit]
			[then]
				{VOADAR_CHANGE_SIDE Grigar}
				{VOADAR_MESSAGE Grigar (_"Hm. I stay! Voadar good. I stay!")}
			[/then]
		[/if]
		[if]
			[have_unit]
				id=Leonna
			[/have_unit]
			[then]
				{VOADAR_CHANGE_SIDE Leonna}
				{VOADAR_MESSAGE Leonna (_"I've known all along that I would side with Voadar! It's the least I could do, after all that he's... <i>sniff sniff...</i>")}
			[/then]
		[/if]
		
		# Ivan is acting fishy (and might explain where the gladiator boys are)
		{IF_VAR persist.Nickieldur.quest_complete equals yes (
			[then]
				{VOADAR_MESSAGE Ivan (_"Now everyone hold on a damned minute! You don't actually want to start a fight, do you?? Mayor Ronry could send for soldiers from the capital before you know it! The only smart folks in this village were the tourist boys, for leavin' the minute they heard about this riot!")}
				{VARIABLE begin_Tetaitiel_message "The boys left for a different reason; it seemed Nickieldur was excited about something. Regardless,"}
			[/then]
			[else]
				{VOADAR_MESSAGE Ivan (_"Now everyone hold on a danged minute! You don't actually want to start a fight, do you?? Mayor Ronry could send for soldiers from the capital before you know it! You're all out of your minds!")}
				{VARIABLE begin_Tetaitiel_message "No,"}
			[/else]
		)}
		
		# Almost finally, the gladiator chiefs:
		{IF_VAR persist.gladiators.quest_complete equals yes (
			[then]
				{VOADAR_CHANGE_SIDE Tetaitiel}
				{VOADAR_CHANGE_SIDE Commodir}
				{VOADAR_MESSAGE Tetaitiel (_"$begin_Tetaitiel_message| I believe Maple is right. It is too late for negotiation, and the mayor must be dealt with harshly. Voadar, we will lend you our bows if need be.")}
			[/then]
			[else]
				{VOADAR_MESSAGE Tetaitiel (_"$begin_Tetaitiel_message| I believe Maple is right. The mayor should be dealt with harshly. However...")}
				{VOADAR_MESSAGE Commodir (_"Voadar, what did you do with the charm we gave you?")}
				{VOADAR_MESSAGE Tetaitiel (_"It was not given lightly, and in the wrong hands is dangerous to our tribe, which is already in troubled times. So now, we finally close the arena and bid Raplice farewell. ")}
				{MOVE_UNIT (id=Commodir) 43 8}
				[kill]
					id=Commodir
				[/kill]
				{MOVE_UNIT (id=Tetaitiel) 43 8}
				[kill]
					id=Tetaitiel
				[/kill]
				[delay]
					time=600
				[/delay]
				{VOADAR_MESSAGE_RIGHT Nhardril (_"<i>(Shakes head)</i>")}
			[/else]
		)}
		{CLEAR_VARIABLE begin_Tetaitiel_message}
		
		{VOADAR_MESSAGE Gwain (_"Well, boss, that just leaves us. Before I say anything else... what are your orders?")}
		{VOADAR_MESSAGE George (_"Well, I... hem, it seems...")}
		{VOADAR_MESSAGE_NARRATOR (_"<span size='xx-large'><b>BOOM BOOM BOOM</b></span>")}
		
		[message]
			speaker=narrator
			caption=_"Unfamiliar voice"
			# no image
			message=_"Open this door! This is Sir Yorksha, captain of Her Majesty's Twelfth Regiment!"
		[/message]
		[delay]
			time=1000
		[/delay]
		[if]
			[have_unit]
				id=Mrs_aristo
			[/have_unit]
			[then]
				{VOADAR_MESSAGE Mrs_aristo (_"Best consider quickly, general. The rest of us have chosen our side.")}
			[/then]
			[else]
				[if]
					[have_unit]
						id=Anatil
					[/have_unit]
					[then]
						{VOADAR_MESSAGE Anatil (_"<i>(Grimly)</i> Better make your decision fast, George. The rest of us here are making good on our word.")}
					[/then]
					[else]
						{VOADAR_MESSAGE_RIGHT Nhardril (_"<i>(Grimly)</i> Better make your decision fast, George. The rest of us here are making good on our word.")}
					[/else]
				[/if]
			[/else]
		[/if]
		[delay]
			time=1000
		[/delay]
		
		#################################################
		#
		# Everyone goes outside, and the Royal Army appears
		#
		#################################################
		
		[store_unit]
			variable=units_to_move
			[filter]
				[not]
					# These folks are handled separately:
					id=Voadar,Ivan,Nhardril,Maple,George,Gwain,Harold
				[/not]
			[/filter]
		[/store_unit]
		
		# Make the royal regiment
#define VOADAR_SOLDIER TYPE X Y
    [unit]
        x,y={X},{Y}
        type={TYPE}
        side=2
        facing=sw
    [/unit]
#enddef
		{VOADAR_SOLDIER "Royal Captain" 21 8}
		[+unit]
			id=Yorksha
			name=_"Sir Yorksha"
		[/unit]
		{VOADAR_SOLDIER "Royal Infantry" 21 7}
		{VOADAR_SOLDIER "Royal Swordsman" 22 6}
		{VOADAR_SOLDIER "Royal Knight" 22 7}
		{VOADAR_SOLDIER "Royal Infantry" 21 9}
		{VOADAR_SOLDIER "Royal Knight" 22 8}
		{VOADAR_SOLDIER "Royal Swordsman" 22 9}
		{VOADAR_SOLDIER "Royal Mercenary" 23 7}
		{VOADAR_SOLDIER "Royal Infantry" 23 6}
		{VOADAR_SOLDIER "Royal Mercenary" 23 8}
		{VOADAR_SOLDIER "Royal Infantry" 23 10}
		{VOADAR_SOLDIER "Royal Mercenary" 23 9}
		{VOADAR_SOLDIER "Royal Swordsman" 24 6}
		{VOADAR_SOLDIER "Royal Mage" 24 7}
		{VOADAR_SOLDIER "Royal Archer" 25 7}
		{VOADAR_SOLDIER "Royal Swordsman" 24 9}
		{VOADAR_SOLDIER "Royal Archer" 25 8}
		{VOADAR_SOLDIER "Royal Mage" 24 8}
		{VOADAR_SOLDIER "Royal Archer" 25 9}
#undef VOADAR_SOLDIER
		
		# These two first,
		{MOVE_UNIT (id=Nhardril) 36 4}
		{TELEPORT_UNIT (id=Nhardril) 15 8}
		{VOADAR_FACE Nhardril se}
		{MOVE_UNIT (id=Maple) 36 4}
		{TELEPORT_UNIT (id=Maple) 15 8}
		{VOADAR_FACE Maple se}
		# Then Ivan disappears (change his side to avoid stupid VoC stuff)
		{VOADAR_CHANGE_SIDE Ivan}
		{MOVE_UNIT (id=Ivan) 36 4}
		[kill]
			id=Ivan
		[/kill]
		
		# Then half the remaining people:
		{VARIABLE half_count $units_to_move.length|}
		{VARIABLE_OP half_count divide 2}
		{VARIABLE_OP half_count sub 1}
		[for]
			end=$half_count|
			[do]
				{MOVE_UNIT (id=$units_to_move[0].id|) 36 4}
				{TELEPORT_UNIT (id=$units_to_move[0].id|) 15 8}
				{VOADAR_FACE $units_to_move[0].id| se}
				{CLEAR_VARIABLE units_to_move[0]}
			[/do]
		[/for]
		{CLEAR_VARIABLE half_count}
		
		# Then Voadar:
		[remove_shroud]
			side=1
			x=0-33
			include_borders=yes
		[/remove_shroud]
		# He goes right in the center, so Nhardril has to scoot:
		{VOADAR_STORE_UNIT Nhardril yes}
		{GENERIC_UNIT 1 "Fog Clearer" 15 8}
		[unstore_unit]
			variable=Nhardril.unit
			find_vacant=yes
		[/unstore_unit]
		[kill]
			type=Fog Clearer
		[/kill]
		{CLEAR_VARIABLE Nhardril}
		{MOVE_UNIT (id=Voadar) 36 4}
		{TELEPORT_UNIT (id=Voadar) 19 11}
		{SCROLL_TO 19 11}
		{MOVE_UNIT (id=Voadar) 15 8}
		{VOADAR_FACE Voadar se}
		[place_shroud]
			side=1
			x=34-51
			include_borders=yes
		[/place_shroud]
		
		# Then the guards:
		{TELEPORT_UNIT (id=George) 19 11}
		{MOVE_UNIT (id=George) 19 8}
		{VOADAR_FACE George se}
		{TELEPORT_UNIT (id=Harold) 19 11}
		{MOVE_UNIT (id=Harold) 19 7}
		{VOADAR_FACE Harold se}
		{TELEPORT_UNIT (id=Gwain) 19 11}
		{MOVE_UNIT (id=Gwain) 19 9}
		{VOADAR_FACE Gwain se}
		
		# Then everyone else
		[for]
			array=units_to_move
			[do]
				{TELEPORT_UNIT (id=$units_to_move[$i|].id|) 19 11}
				{MOVE_UNIT (id=$units_to_move[$i|].id|) 15 8}
				{VOADAR_FACE $units_to_move[$i|].id| se}
			[/do]
		[/for]
		{CLEAR_VARIABLE units_to_move}
		
		#################################################
		# The Royal army... explains... its stance,
		# and the town guards take their sides
		#################################################
		
		{VOADAR_MESSAGE_RIGHT Yorksha (_"Attention all citizens! One among you is accused of sedition! By Her Majesty's decree, Voadar the drake will return to the capital to stand trial!")}
		{VOADAR_MESSAGE George (_"<i>(Almost at a loss for words)</i> Captain! I... recognize your authority, but I must question whether this is necessary! I... the one you named is an upstanding citizen. Voadar has done nothing that could be considered treason, and--")}
		{VOADAR_MESSAGE Hob (_"Has so! We all have! We're rioting!!!")}
		{VOADAR_FACE George sw}
		{VOADAR_MESSAGE_RIGHT George (_"NO! Everyone, don't make this worse than it is!")}
		[if]
			[have_unit]
				id=Anatil
			[/have_unit]
			[then]
				{VOADAR_MESSAGE Anatil (_"Auch! He's got a loud mouth, but the lad's right! We'd sooner die than hand a friend over to them!")}
			[/then]
			[else]
				[if]
					[have_unit]
						id=Vyncent
					[/have_unit]
					[then]
						{VOADAR_MESSAGE Vyncent (_"Give it up! He's got a loud mouth, but the kid is right! We'll never let them touch our friend!")}
					[/then]
					[else]
						{VOADAR_MESSAGE Frank (_"Stop it, George! Hob's right! We'll die before letting them touch our friend!")}
					[/else]
				[/if]
			[/else]
		[/if]
		{VOADAR_MESSAGE_NARRATOR (_"Yells of agreement broke out through the crowd! Voadar's comrades circled tight around him, outraged at the royal soldier's threat. But Captain Yorksha raised his voice over their jeers.")}
		{VOADAR_FACE George se}
		{VOADAR_MESSAGE_RIGHT Yorksha (_"So be it! You are all charged with insurrection and accessory sedition! Surrender your weapons immediately, or we shall respond with lethal force!")}
		{VOADAR_MESSAGE George (_"CAPTAIN! Please, these people are--")}
		
		
		{REPLACE_SCENARIO_MUSIC silence.ogg}
		{MOVE_UNIT (id=Yorksha) 20 8}
		[harm_unit]
			[filter]
				id=George
			[/filter]
			[filter_second]
				id=Yorksha
			[/filter_second]
			amount=60
			animate=yes
			[primary_attack]
				type=blade
			[/primary_attack]
			[secondary_attack]
				type=blade
			[/secondary_attack]
		[/harm_unit]
		{VOADAR_MESSAGE George (_"AAHG!")}
		# This is the playlist for the rest of the scenario:
		{REPLACE_SCENARIO_MUSIC frantic.ogg}
		{APPEND_MUSIC loyalists.ogg}
		{APPEND_MUSIC siege_of_laurelmor.ogg}
		{APPEND_MUSIC battle.ogg}
		[harm_unit]
			[filter]
				id=George
			[/filter]
			[filter_second]
				id=Yorksha
			[/filter_second]
			amount=60
			kill=yes
			animate=yes
			[primary_attack]
				type=blade
			[/primary_attack]
			[secondary_attack]
				type=blade
			[/secondary_attack]
		[/harm_unit]
		{VOADAR_CHANGE_SIDE Gwain}
		{VOADAR_MESSAGE Gwain (_"NO!")}
		{MOVE_UNIT (id=Gwain) 17 9}
		{VOADAR_FACE Gwain se}
		{VOADAR_MESSAGE_RIGHT Yorksha (_"Captain George of the Raplice Garrison is hereby convicted of treason! I repeat that we are authorized to use lethal force! Lay down your weapons and surrender, or hesitate and be executed!")}
		
		# Finally, harold:
		{IF_VAR persist.Voadar.total_stolen_count less_than 3 (
			[then]
				{VOADAR_CHANGE_SIDE Harold}
				{MOVE_UNIT (id=Harold) 17 7}
				{VOADAR_FACE Harold se}
			[/then]
			[else]
				{VOADAR_MESSAGE Gwain (_"Harold! Get away from them!")}
				{VOADAR_MESSAGE Harold (_". . .")}
				{MOVE_UNIT (id=Harold) 20 7}
				{VOADAR_FACE Harold sw}
				{VOADAR_MESSAGE_RIGHT Harold (_"All of you disgust me! You're defending a THIEF! I saw you robbing them, Voadar! I'm not wasting my life here!")}
				{VOADAR_MESSAGE_RIGHT Yorksha (_"At least one of you knows his duty! COMPANY, ATTACK!")}
			[/else]
		)}
		{VOADAR_MESSAGE Nhardril (_"BACK TO THE RIVER! We'll make a stand behind the pond and the arena!")}
		
		[store_unit]
			[filter]
				side=1
				[not]
					id=Voadar
				[/not]
			[/filter]
			variable=units_to_move
		[/store_unit]
		{MOVE_UNIT (id=Voadar) 7 11}
		{VOADAR_FACE Voadar se}
		[for]
			array=units_to_move
			[do]
				{TELEPORT_UNIT (id=$units_to_move[$i|].id|) 7 11}
				{VOADAR_FACE $units_to_move[$i|].id| se}
			[/do]
		[/for]
		{CLEAR_VARIABLE units_to_move}
		
		# then they charge:
		[end_turn]
		[/end_turn]
		
		# and the scenario begins.
		
		# but.
		
		# The gladiator boys might show up in another turn.
		[if]
			[variable]
				name=persist.Nickieldur.quest_complete
				equals=yes
			[/variable]
			[then]
				[event]
					name=turn 3
					id=gladiators_appear
					{VARIABLE Nickieldur.unit.facing sw}
					{VARIABLE Nickieldur.unit.side 1}
					[unstore_unit]
						variable=Nickieldur.unit
						x,y=28,8
						find_vacant=yes
					[/unstore_unit]
					{VARIABLE Derek.unit.facing sw}
					{VARIABLE Derek.unit.side 1}
					[unstore_unit]
						variable=Derek.unit
						x,y=28,8
						find_vacant=yes
					[/unstore_unit]
					{VARIABLE Rayyan.unit.facing sw}
					{VARIABLE Rayyan.unit.side 1}
					[unstore_unit]
						variable=Rayyan.unit
						x,y=28,8
						find_vacant=yes
					[/unstore_unit]
					
					{CLEAR_VARIABLE Nickieldur}
					{CLEAR_VARIABLE Derek}
					{CLEAR_VARIABLE Rayyan}
					
					# They aren't quite as OP as if you were to fight them at high level
					# in the arena, but they are formidable
					[modify_unit]
						[filter]
							id=Nickieldur
						[/filter]
						[effect]
							apply_to=attack
							range=melee
							set_damage=11
						[/effect]
						[effect]
							apply_to=attack
							range=ranged
							set_number=4
						[/effect]
						max_hitpoints=99
						hitpoints=99
					[/modify_unit]
					[modify_unit]
						[filter]
							id=Derek
						[/filter]
						[effect]
							apply_to=attack
							range=melee
							set_damage=12
						[/effect]
						max_hitpoints=122
						hitpoints=122
					[/modify_unit]
					[modify_unit]
						[filter]
							id=Rayyan
						[/filter]
						[effect]
							apply_to=attack
							range=melee
							set_damage=10
						[/effect]
						[effect]
							apply_to=attack
							range=ranged
							set_damage=11
							[set_specials]
								{WEAPON_SPECIAL_FIRSTSTRIKE}
							[/set_specials]
						[/effect]
						max_hitpoints=83
						hitpoints=83
					[/modify_unit]
					
					{IF_VAR persist.Robert.quest_complete equals yes (
						[then]
							{VARIABLE Robert.unit.facing sw}
							{VARIABLE Robert.unit.side 1}
							[unstore_unit]
								variable=Robert.unit
								x,y=28,8
								find_vacant=yes
							[/unstore_unit]
							{CLEAR_VARIABLE Robert}
						[/then]
					)}
					{VOADAR_MESSAGE_RIGHT Derek (_"Looks like we were right.")}
					{VOADAR_MESSAGE_RIGHT Nickieldur (_"Oh no! Voadar, that charm you showed me finally helped me remember! I remembered which elf tribe I'm from! We had just left to go there, but we saw the army going the other way...")}
					{IF_VAR persist.Robert.quest_complete equals yes (
						[then]
							{VOADAR_MESSAGE_RIGHT Robert (_"We all owe a lot to you, so when we suspected trouble we had to come back!")}
							[if]
								[have_unit]
									id=Mrs_aristo
								[/have_unit]
								[then]
									{VOADAR_MESSAGE Mrs_aristo (_"Robert, no... this battle finally made me glad you wanted to set off on your own...")}
									{VOADAR_MESSAGE_RIGHT Robert (_"Don't worry, mother. We're both making it out of this okay.")}
								[/then]
							[/if]
						[/then]
					)}
					{VOADAR_MESSAGE_RIGHT Rayyan (_"AAAEEEIII!!! WE ARE COME SAVE YOU, ALL!")}
				[/event]
			[/then]
		[/if]
	[/event]
	
	# try to keep yorksha alive by slowing him down on the first enemy turn
	# it's not a big deal if he dies, but the dialog later is a bit better with him alive
	[event]
		name=side 2 turn refresh
		id=slow_Yorksha
		[modify_unit]
			[filter]
				id=Yorksha
			[/filter]
			moves=0
		[/modify_unit]
	[/event]
    
	# you don't have to kill all of them to win
	[event]
		name=start
		id=count_soldiers
		[store_unit]
			[filter]
				side=2
			[/filter]
			variable=enemy_units
		[/store_unit]
		{VARIABLE required_enemies $enemy_units.length|}
		{VARIABLE hint_enemies $enemy_units.length|}
		{CLEAR_VARIABLE enemy_units}
		{VARIABLE_OP required_enemies divide 2}
		{VARIABLE_OP hint_enemies divide 4}
		
		{VARIABLE killed_enemies 0}
		{VARIABLE killed_allies 0}
	[/event]
    [event]
		name=die
		id=count_dead_enemies
		first_time_only=no
		[filter]
			side=2
		[/filter]
		{VARIABLE_OP killed_enemies add 1}
		{IF_VAR killed_enemies greater_than_equal_to $hint_enemies| (
			[then]
				[fire_event]
					name=enemies_complain
				[/fire_event]
			[/then]
		)}
		{IF_VAR killed_enemies greater_than_equal_to $required_enemies| (
			[variable]
				name=killed_enemies
				greater_than_equal_to=$killed_allies|
			[/variable]
			[then]
				[fire_event]
					name=enemies_retreat
				[/fire_event]
			[/then]
		)}
    [/event]
	[event]
		name=die
		id=count_dead_allies
		first_time_only=no
		[filter]
			side=1
		[/filter]
		{VARIABLE_OP killed_allies add 1}
	[/event]
	
	[event]
		name=enemies_complain
		id=enemies_complain
		[role]
			role=nervous
			side=2
			[not]
				id=Yorksha,Harold
			[/not]
		[/role]
		[if]
			[have_unit]
				id=Yorksha
			[/have_unit]
			[then]
				[message]
					role=nervous
					message=_"With all respect, captain, we've taken a lot of casualties. We should consider a tactical retreat."
				[/message]
				{VOADAR_MESSAGE_RIGHT Yorksha (_"Nonsense, this rabble can't intimidate the royal army!")}
			[/then]
			[else]
				[message]
					role=nervous
					message=_"Company, be on the ready for a retreat order."
				[/message]
			[/else]
		[/if]
	[/event]
	
	[event]
		name=enemies_retreat
		id=enemies_retreat
		# Don't start until a side two turn, so the dialog lines up with their retreat
		[event]
			name=side 2 turn
			
			[micro_ai]
				side=2
				ai_type=goto
				action=add
				[filter_location]
					x=32
					y=5-11
				[/filter_location]
				[filter]
					[not]
						id=Yorksha
					[/not]
				[/filter]
			[/micro_ai]
			[role]
				role=nervous
				side=2
				[not]
					id=Yorksha,Harold
				[/not]
			[/role]
			[if]
				[have_unit]
					id=Yorksha
				[/have_unit]
				[then]
					[message]
						role=nervous
						message=_"Sir, we have to retreat and return with reinforcements! We've lost too many good soldiers!"
					[/message]
					{VOADAR_MESSAGE_RIGHT Yorksha (_"Silence! We must crush this rebellion!")}
					[role]
						role=nervous2
						side=2
						[not]
							id=Yorksha,Harold
							[or]
								role=nervous
							[/or]
						[/not]
						[else]
							[role]
								role=nervous2
								[and]
									role=nervous
								[/and]
							[/role]
						[/else]
					[/role]
					[message]
						role=nervous2
						message=_"Forget the rebellion, I'm getting out of here!"
					[/message]
					{VOADAR_MESSAGE_RIGHT Yorksha (_"Soldier, you break rank and I'll have you court martialed!")}
					[message]
						role=nervous2
						message=_"I'll take my chances in court over my chances here!"
					[/message]
				[/then]
				[else]
					[message]
						role=nervous
						message=_"Company retreat! They've beaten us for now!"
					[/message]
				[/else]
			[/if]
			
			[event]
				name=side 2 turn
				id=Yorksha_retreats
				{VOADAR_MESSAGE Yorksha (_"Cowards! Spineless fools! GRAH! I am left with no choice!")}
				{VOADAR_MESSAGE_RIGHT Yorksha (_"Peasants, we may retreat now, but don't think this is over!")}
				[micro_ai]
					# And Yorksha gets the same micro_ai that everyone else already has
					# gotta love copy/paste
					# ...
					# I am so lazy
					side=2
					ai_type=goto
					action=add
					[filter_location]
						x=32
						y=5-11
					[/filter_location]
					[filter]
						id=Yorksha
					[/filter]
				[/micro_ai]
			[/event]
			
			# Also, at this point any soldier who reaches the east side of the town escapes
			[event]
				name=moveto
				id=soldier_escapes
				first_time_only=no
				[filter]
					side=2
					x=32
				[/filter]
				[kill]
					id=$unit.id
					animate=no
				[/kill]
				[fire_event]
					id=all_soldiers_gone
				[/fire_event]
			[/event]
		[/event]
	[/event]
	
	# You win when all enemies are gone (dead or retreated)
	[event]
		name=die
		id=all_soldiers_gone
		[filter_condition]
			[have_unit]
				side=2
				count=0
			[/have_unit]
		[/filter_condition]
		# Ug, dialog here is hard because literally anyone other than Voadar could be dead
		# let's just deal with it in the next scenario's [story], easier to be vague there
		[endlevel]
			result=victory
		[/endlevel]
	[/event]
	
	
	[event]
		name=victory
		id=valor_clear_variables
		{CLEAR_VARIABLE required_enemies}
		{CLEAR_VARIABLE hint_enemies}
		{CLEAR_VARIABLE killed_enemies}
		{CLEAR_VARIABLE killed_allies}
		
		# Keep most persist vars intact just in case I want to use them
		# but with Voadar it's easier to use the normal variable instead
		{CLEAR_VARIABLE persist.Voadar}
		
		{VOADAR_STORE_UNIT Voadar no}
		{VARIABLE Voadar.unit.hitpoints $Voadar.unit.max_hitpoints|}
	[/event]
	
	# It's nice to see the battlefield after losing:
	[event]
		name=defeat
		id=defeat_lift_fog
		[modify_side]
			side=1
			fog=no
		[/modify_side]
	[/event]
    
    # Place images, decorations, and labels
    [event]
        name=prestart
        id=tutorial_place_images
        
        {PLACE_IMAGE "scenery/leanto.png" 15 10}
        {PLACE_IMAGE "items/enhantress-statue-e-normal.png" 12 11}
    [/event]

	# Death events, including Voadar's
	{~add-ons/Voyage_of_a_Drake/utils/end_scenarios/valor_deaths.cfg}
		
[/scenario]
